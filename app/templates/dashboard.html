{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<!-- Page Title -->
<h1 class="text-3xl font-bold text-slate-900 mb-2">Analytics Dashboard</h1>
<p class="text-lg text-slate-500 mb-8">An overview of airline sentiment and model performance.</p>

<!-- Dashboard Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Card 1: Model Information -->
    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-slate-900 mb-4">Model Information</h2>
        <div class="space-y-3 text-sm">
            <div class="flex justify-between">
                <span class="text-slate-500">Current Version:</span>
                <span class="font-medium text-slate-700">v{{ current_model.version_number if current_model.version_number else '1.0' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-slate-500">Model Accuracy:</span>
                <span class="font-medium text-green-600">{{ (model_accuracy * 100)|round(2) }}%</span>
            </div>
            <div class="flex justify-between">
                <span class="text-slate-500">Training Samples:</span>
                <span class="font-medium text-slate-700">{{ current_model.training_samples if current_model.training_samples else 'N/A' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-slate-500">Top Mentioned Airline:</span>
                <span class="font-medium text-slate-700">{{ top_airline.airline if top_airline else 'N/A' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-slate-500">Most Cited Reason:</span>
                <span class="font-medium text-slate-700">{{ top_negative_reason.negativereason if top_negative_reason else 'N/A' }}</span>
            </div>
        </div>
    </div>
    
    <!-- Card 2: Sentiment Composition -->
    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-slate-900 mb-4">Sentiment Composition</h2>
        <div class="h-64">
            <canvas id="sentimentBarChart"></canvas>
        </div>
    </div>

    <!-- Card 3: Sentiment Share -->
    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-slate-900 mb-4">Sentiment Share</h2>
        <div class="h-64">
            <canvas id="sentimentDoughnutChart"></canvas>
        </div>
    </div>

    <!-- Card 4: Top Negative Drivers -->
    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-slate-900 mb-4">Top Negative Drivers</h2>
        <div class="h-64">
            <canvas id="negativeDriversChart"></canvas>
        </div>
    </div>

    <!-- Card 5: Timeline of Tweets -->
    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-slate-900 mb-4">Timeline of Tweets</h2>
        <div class="h-72">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CHART.JS MOCK DATA & INITIALIZATION ---
    
    // Set default font for all charts
    Chart.defaults.font.family = 'Inter';
    Chart.defaults.font.weight = '500';
    Chart.defaults.color = '#334155'; // slate-700

    // Data from Flask
    const sentimentData = {{ sentiment_summary|tojson }};
    const negativeReasonsData = {{ negative_reasons|tojson }};
    const timelineData = {{ timeline_data|tojson }};

    // Chart 1: Sentiment Bar Chart
    const ctxBar = document.getElementById('sentimentBarChart')?.getContext('2d');
    if (ctxBar) {
        const labels = sentimentData.map(d => d.sentiment);
        const counts = sentimentData.map(d => d.count);
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tweet Count',
                    data: counts,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)', // red-500
                        'rgba(234, 179, 8, 0.7)', // yellow-500
                        'rgba(34, 197, 94, 0.7)', // green-500
                    ],
                    borderColor: [
                        'rgb(239, 68, 68)',
                        'rgb(234, 179, 8)',
                        'rgb(34, 197, 94)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { drawBorder: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // Chart 2: Sentiment Doughnut Chart
    const ctxDoughnut = document.getElementById('sentimentDoughnutChart')?.getContext('2d');
    if (ctxDoughnut) {
        const labels = sentimentData.map(d => d.sentiment);
        const counts = sentimentData.map(d => d.count);
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgb(239, 68, 68)', // red-500
                        'rgb(234, 179, 8)', // yellow-500
                        'rgb(34, 197, 94)', // green-500
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true }
                    }
                }
            }
        });
    }

    // Chart 3: Top Negative Drivers (Horizontal Bar)
    const ctxHBar = document.getElementById('negativeDriversChart')?.getContext('2d');
    if (ctxHBar) {
        const labels = negativeReasonsData.map(d => d.negativereason);
        const counts = negativeReasonsData.map(d => d.count);
        new Chart(ctxHBar, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Mention Count',
                    data: counts,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)', // red-500
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // This makes it a horizontal bar chart
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { drawBorder: false } },
                    y: { grid: { display: false } }
                }
            }
        });
    }

    // Chart 4: Timeline
    const ctxLine = document.getElementById('timelineChart')?.getContext('2d');
    if (ctxLine) {
        const labels = timelineData.map(d => new Date(d.tweet_created).toLocaleDateString());
        const counts = timelineData.map(d => d.tweet_count);
        new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Tweets',
                        data: counts,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

});
</script>
{% endblock %}