{% extends "base.html" %}

{% block title %}Admin Panel - Review Queue{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-slate-900">Admin Review Panel</h1>
        <p class="text-lg text-slate-500">Review submissions and manage model training.</p>
    </div>
    <a href="{{ url_for('main.logout') }}" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-150 flex items-center">
        <i data-lucide="log-out" class="mr-2 h-4 w-4"></i>
        Logout
    </a>
</div>

<!-- Model Training Section -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-8">
    <h2 class="text-xl font-semibold text-slate-900 mb-4">Model Training</h2>
    <div class="flex items-center justify-between">
        <div>
            <p class="text-slate-600"><strong>{{ submissions.approved|selectattr('true_sentiment')|list|length }}</strong> approved reviews available for training.</p>
            <p class="text-sm text-slate-500">Minimum 50 reviews with true sentiment required for retraining.</p>
        </div>
        <button id="retrainBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 flex items-center justify-center" onclick="startRetraining()">
            <span id="retrainText">Retrain Model</span>
            <span id="retrainSpinner" style="display:none;">Training...</span>
        </button>
    </div>
    <div id="trainingResults" style="display:none; margin-top: 20px;"></div>
</div>

<!-- Comparison Modal -->
<div id="comparisonModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4" style="display:none;">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
        <h2 class="text-2xl font-bold text-slate-900 mb-4">Model Training Complete</h2>
        <div id="comparisonDetails"></div>
        <div class="mt-6 flex justify-end space-x-4">
            <button onclick="keepOldModel()" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Keep Current Model</button>
            <button onclick="activateNewModel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Use New Model</button>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="mb-4 border-b border-slate-200">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button class="tab-btn active" onclick="showTab('pending', this)">Pending ({{ submissions.pending|length }})</button>
        <button class="tab-btn" onclick="showTab('approved', this)">Approved ({{ submissions.approved|length }})</button>
        <button class="tab-btn" onclick="showTab('rejected', this)">Rejected ({{ submissions.rejected|length }})</button>
    </nav>
</div>

<!-- Tab Content -->
<div id="pending-tab" class="tab-content active">
    {% include 'admin_table.html' with context %}
</div>
<div id="approved-tab" class="tab-content" style="display:none;">
    {% include 'admin_table_approved.html' with context %}
</div>
<div id="rejected-tab" class="tab-content" style="display:none;">
    {% include 'admin_table_rejected.html' with context %}
</div>

{% endblock %}

{% block scripts %}
<script>
let newModelVersion = null;
let trainingTaskId = null;
let trainingPollInterval = null;

function showTab(tabName, button) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`${tabName}-tab`).style.display = 'block';
    button.classList.add('active');
}

async function startRetraining() {
    const btn = document.getElementById('retrainBtn');
    const text = document.getElementById('retrainText');
    const spinner = document.getElementById('retrainSpinner');
    const results = document.getElementById('trainingResults');

    btn.disabled = true;
    text.style.display = 'none';
    spinner.style.display = 'inline';
    results.style.display = 'none';
    results.innerHTML = '';

    try {
        const response = await fetch('{{ url_for("main.retrain_model") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.error) {
            results.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">${data.error}</div>`;
            results.style.display = 'block';
        } else if (data.task_id) {
            trainingTaskId = data.task_id;
            results.innerHTML = '<div class="p-4 rounded-md bg-blue-100 text-blue-700">Training started. This may take a few moments...</div>';
            results.style.display = 'block';
            pollTrainingStatus();
        } else if (data.version) {
            handleSuccessfulRetrain(data);
        }
    } catch (error) {
        results.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">Training failed: ${error.message}</div>`;
        results.style.display = 'block';
    } finally {
        btn.disabled = false;
        text.style.display = 'inline';
        spinner.style.display = 'none';
    }
}

function stopTrainingPoll() {
    if (trainingPollInterval) {
        clearInterval(trainingPollInterval);
        trainingPollInterval = null;
    }
}

function handleSuccessfulRetrain(data) {
    newModelVersion = data.version;
    const results = document.getElementById('trainingResults');
    results.innerHTML = `<div class="p-4 rounded-md bg-green-100 text-green-700">Model retraining completed successfully. New version v${data.version} is ready for review.</div>`;
    results.style.display = 'block';
    showComparisonModal(data);
}

function pollTrainingStatus() {
    if (!trainingTaskId) {
        return;
    }

    const results = document.getElementById('trainingResults');
    stopTrainingPoll();

    trainingPollInterval = setInterval(async () => {
        try {
            const response = await fetch(`{{ url_for('main.retrain_status', task_id='__TASK__') }}`.replace('__TASK__', trainingTaskId));
            const data = await response.json();

            if (data.status === 'pending') {
                return;
            }

            stopTrainingPoll();

            if (data.status === 'failed') {
                stopTrainingPoll();
                trainingTaskId = null;
                results.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">Training failed: ${data.error}</div>`;
                results.style.display = 'block';
                return;
            }

            if (data.status === 'complete' && data.result) {
                stopTrainingPoll();
                trainingTaskId = null;
                const payload = data.result;
                handleSuccessfulRetrain(payload);
            }
        } catch (error) {
            stopTrainingPoll();
            trainingTaskId = null;
            results.innerHTML = `<div class="p-4 rounded-md bg-red-100 text-red-700">Training status error: ${error.message}</div>`;
            results.style.display = 'block';
        }
    }, 2000);
}

function showComparisonModal(data) {
    const modal = document.getElementById('comparisonModal');
    const details = document.getElementById('comparisonDetails');

    const improvement = data.accuracy_difference > 0
        ? `<span class="text-green-600">+${data.improvement_percentage.toFixed(2)}% improvement</span>`
        : `<span class="text-red-600">${data.improvement_percentage.toFixed(2)}% change</span>`;

    details.innerHTML = `
        <div class="grid grid-cols-2 gap-6 text-center">
            <div>
                <h3 class="text-lg font-medium text-slate-500">Current Model</h3>
                <p class="text-4xl font-bold text-slate-800 mt-2">${(data.old_accuracy * 100).toFixed(2)}%</p>
                <p class="text-sm text-slate-500">Accuracy</p>
            </div>
            <div>
                <h3 class="text-lg font-medium text-slate-500">New Model (v${data.version})</h3>
                <p class="text-4xl font-bold text-green-600 mt-2">${(data.new_accuracy * 100).toFixed(2)}%</p>
                <p class="text-sm text-slate-500">Accuracy</p>
            </div>
        </div>
        <div class="mt-6 bg-slate-50 p-4 rounded-lg">
            <p><strong>Change:</strong> ${improvement}</p>
            <p><strong>Training samples:</strong> ${data.training_samples} (${data.new_samples} new)</p>
            <p class="text-sm text-slate-600 mt-2">Choose whether to activate the new model or keep using the current one.</p>
        </div>
    `;

    modal.style.display = 'flex';
}

async function activateNewModel() {
    if (!newModelVersion) {
        return;
    }

    try {
        const response = await fetch(`{{ url_for('main.activate_model', version=0) }}`.replace('0', newModelVersion), {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            alert('New model activated. The page will reload.');
            window.location.reload();
        } else if (data.error) {
            alert('Failed to activate model: ' + data.error);
        }
    } catch (error) {
        alert('Error activating model: ' + error.message);
    }
}

function keepOldModel() {
    document.getElementById('comparisonModal').style.display = 'none';
    const results = document.getElementById('trainingResults');
    results.innerHTML = `<div class="p-4 rounded-md bg-blue-100 text-blue-700">New model version ${newModelVersion} saved but not activated. Current model remains in use.</div>`;
    results.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize the first tab
    showTab('pending', document.querySelector('.tab-btn'));
});
</script>
<style>
.tab-btn {
    padding: 1rem;
    font-weight: 600;
    border-bottom: 2px solid transparent;
    color: #64748b;
}
.tab-btn.active {
    color: #0f172a;
    border-bottom-color: #f97316;
}
.tab-btn:hover {
    color: #0f172a;
}
</style>
{% endblock %}
